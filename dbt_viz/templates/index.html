<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dbt Model Lineage</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        #graph {
            flex: 1;
            position: relative;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #search {
            padding: 10px 15px;
            border: 1px solid #3a3a5c;
            border-radius: 8px;
            background: #252542;
            color: #eee;
            font-size: 14px;
            width: 250px;
            outline: none;
        }

        #search:focus {
            border-color: #6c63ff;
        }

        #search::placeholder {
            color: #888;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #3a3a5c;
            border-radius: 8px;
            background: #252542;
            color: #eee;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: #3a3a5c;
        }

        #legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: #252542;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a3a5c;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        #details-panel {
            width: 400px;
            background: #252542;
            border-left: 1px solid #3a3a5c;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        #details-panel.visible {
            display: block;
        }

        #details-panel h2 {
            font-size: 18px;
            margin-bottom: 5px;
            color: #fff;
        }

        #details-panel .resource-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        #details-panel .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        #details-panel .close-btn:hover {
            color: #fff;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .detail-section p {
            font-size: 14px;
            line-height: 1.5;
            color: #ccc;
        }

        .detail-section .value {
            font-family: 'SF Mono', Monaco, monospace;
            background: #1a1a2e;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }

        .columns-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .column-item {
            padding: 8px;
            background: #1a1a2e;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .column-name {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            color: #6c63ff;
        }

        .column-type {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            color: #888;
            background: #2a2a4a;
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .column-desc {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tag {
            background: #3a3a5c;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .sql-preview {
            background: #1a1a2e;
            padding: 12px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            max-height: 300px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .node {
            cursor: pointer;
        }

        .node rect {
            stroke-width: 2;
            transition: stroke-width 0.2s;
        }

        .node.highlighted rect {
            stroke-width: 4;
        }

        .node.dimmed {
            opacity: 0.2;
        }

        .node text {
            font-size: 12px;
            fill: #fff;
            pointer-events: none;
        }

        .node .node-type {
            font-size: 9px;
            fill: rgba(255,255,255,0.7);
            text-transform: uppercase;
        }

        .node.dimmed text {
            opacity: 0.3;
        }

        .link {
            stroke: #4a4a6c;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .link.highlighted {
            stroke: #6c63ff;
            stroke-width: 3;
        }

        .link.dimmed {
            opacity: 0.1;
        }

        #arrowhead {
            fill: #4a4a6c;
        }

        #arrowhead.highlighted {
            fill: #6c63ff;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="graph">
            <div id="controls">
                <input type="text" id="search" placeholder="Search models...">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-in">+</button>
                    <button class="zoom-btn" id="zoom-out">−</button>
                    <button class="zoom-btn" id="zoom-reset">⟲</button>
                </div>
            </div>
            <div id="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #6c63ff;"></div>
                    <span>Model</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00c9a7;"></div>
                    <span>Source</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc75f;"></div>
                    <span>Seed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>Snapshot</span>
                </div>
            </div>
            <svg></svg>
        </div>
        <div id="details-panel">
            <button class="close-btn" id="close-details">&times;</button>
            <div id="details-content"></div>
        </div>
    </div>

    <script>
        // Colors for different resource types
        const colors = {
            model: '#6c63ff',
            source: '#00c9a7',
            seed: '#ffc75f',
            snapshot: '#ff6b6b'
        };

        // Load data and initialize
        fetch('/data.json')
            .then(response => response.json())
            .then(data => initGraph(data))
            .catch(error => console.error('Error loading data:', error));

        function initGraph(data) {
            const svg = d3.select('svg');
            const container = document.getElementById('graph');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Create arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 8)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .append('path')
                .attr('d', 'M 0,-4 L 8,0 L 0,4')
                .attr('fill', '#4a4a6c');

            // Create main group for zoom/pan
            const g = svg.append('g');

            // Set up zoom
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1.3);
            });
            document.getElementById('zoom-out').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 0.7);
            });
            document.getElementById('zoom-reset').addEventListener('click', () => {
                svg.transition().call(zoom.transform, d3.zoomIdentity);
            });

            // Process nodes and links
            const nodes = data.nodes.map(n => ({...n, id: n.unique_id}));
            const nodeMap = new Map(nodes.map(n => [n.id, n]));

            const links = data.edges
                .filter(e => nodeMap.has(e.source) && nodeMap.has(e.target))
                .map(e => ({
                    source: e.source,
                    target: e.target
                }));

            // Build adjacency for highlighting and layout
            const upstream = new Map();
            const downstream = new Map();
            nodes.forEach(n => {
                upstream.set(n.id, new Set());
                downstream.set(n.id, new Set());
            });
            links.forEach(l => {
                downstream.get(l.source).add(l.target);
                upstream.get(l.target).add(l.source);
            });

            // Calculate layers using longest path from sources
            function calculateLayers() {
                const layers = new Map();
                const visited = new Set();

                // Find all root nodes (no upstream dependencies)
                const roots = nodes.filter(n => upstream.get(n.id).size === 0);

                // BFS to assign layers based on longest path
                function getLongestPath(nodeId, memo = new Map()) {
                    if (memo.has(nodeId)) return memo.get(nodeId);

                    const upstreamNodes = upstream.get(nodeId);
                    if (upstreamNodes.size === 0) {
                        memo.set(nodeId, 0);
                        return 0;
                    }

                    let maxUpstream = 0;
                    upstreamNodes.forEach(upId => {
                        maxUpstream = Math.max(maxUpstream, getLongestPath(upId, memo) + 1);
                    });

                    memo.set(nodeId, maxUpstream);
                    return maxUpstream;
                }

                const memo = new Map();
                nodes.forEach(n => {
                    layers.set(n.id, getLongestPath(n.id, memo));
                });

                return layers;
            }

            const layers = calculateLayers();

            // Group nodes by layer
            const layerGroups = new Map();
            nodes.forEach(n => {
                const layer = layers.get(n.id);
                if (!layerGroups.has(layer)) {
                    layerGroups.set(layer, []);
                }
                layerGroups.get(layer).push(n);
            });

            // Sort layers
            const sortedLayers = Array.from(layerGroups.keys()).sort((a, b) => a - b);
            const numLayers = sortedLayers.length;

            // Layout parameters
            const nodeWidth = 140;
            const nodeHeight = 50;
            const layerSpacing = 220;
            const nodeSpacing = 80;
            const padding = 100;

            // Calculate positions
            sortedLayers.forEach((layerNum, layerIndex) => {
                const nodesInLayer = layerGroups.get(layerNum);
                const layerHeight = nodesInLayer.length * (nodeHeight + nodeSpacing) - nodeSpacing;
                const startY = (height - layerHeight) / 2;

                nodesInLayer.forEach((node, nodeIndex) => {
                    node.x = padding + layerIndex * layerSpacing;
                    node.y = startY + nodeIndex * (nodeHeight + nodeSpacing);
                });
            });

            // Get all upstream/downstream nodes recursively
            function getAllUpstream(nodeId, visited = new Set()) {
                if (visited.has(nodeId)) return visited;
                visited.add(nodeId);
                upstream.get(nodeId)?.forEach(id => getAllUpstream(id, visited));
                return visited;
            }

            function getAllDownstream(nodeId, visited = new Set()) {
                if (visited.has(nodeId)) return visited;
                visited.add(nodeId);
                downstream.get(nodeId)?.forEach(id => getAllDownstream(id, visited));
                return visited;
            }

            // Create curved link path
            function linkPath(d) {
                const sourceNode = nodeMap.get(typeof d.source === 'object' ? d.source.id : d.source);
                const targetNode = nodeMap.get(typeof d.target === 'object' ? d.target.id : d.target);

                const sx = sourceNode.x + nodeWidth;
                const sy = sourceNode.y + nodeHeight / 2;
                const tx = targetNode.x;
                const ty = targetNode.y + nodeHeight / 2;

                const midX = (sx + tx) / 2;

                return `M ${sx},${sy} C ${midX},${sy} ${midX},${ty} ${tx},${ty}`;
            }

            // Create links
            const link = g.append('g')
                .attr('class', 'links')
                .selectAll('path')
                .data(links)
                .enter().append('path')
                .attr('class', 'link')
                .attr('d', linkPath);

            // Create nodes
            const node = g.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Node rectangle
            node.append('rect')
                .attr('width', nodeWidth)
                .attr('height', nodeHeight)
                .attr('rx', 8)
                .attr('ry', 8)
                .attr('fill', d => colors[d.resource_type] || '#888')
                .attr('stroke', d => d3.color(colors[d.resource_type] || '#888').darker(0.5));

            // Node name
            node.append('text')
                .attr('x', nodeWidth / 2)
                .attr('y', nodeHeight / 2 - 2)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .text(d => d.name.length > 16 ? d.name.substring(0, 14) + '...' : d.name);

            // Node type label
            node.append('text')
                .attr('class', 'node-type')
                .attr('x', nodeWidth / 2)
                .attr('y', nodeHeight - 10)
                .attr('text-anchor', 'middle')
                .text(d => d.resource_type);

            // Hover highlighting
            node.on('mouseenter', function(event, d) {
                const upstreamNodes = getAllUpstream(d.id);
                const downstreamNodes = getAllDownstream(d.id);
                const relevantNodes = new Set([...upstreamNodes, ...downstreamNodes]);

                node.classed('highlighted', n => n.id === d.id)
                    .classed('dimmed', n => !relevantNodes.has(n.id));

                link.classed('highlighted', l => {
                    const srcId = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgtId = typeof l.target === 'object' ? l.target.id : l.target;
                    return relevantNodes.has(srcId) && relevantNodes.has(tgtId);
                }).classed('dimmed', l => {
                    const srcId = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgtId = typeof l.target === 'object' ? l.target.id : l.target;
                    return !relevantNodes.has(srcId) || !relevantNodes.has(tgtId);
                });
            });

            node.on('mouseleave', function() {
                node.classed('highlighted', false).classed('dimmed', false);
                link.classed('highlighted', false).classed('dimmed', false);
            });

            // Click to show details
            node.on('click', function(event, d) {
                showDetails(d);
            });

            // Drag functions
            function dragstarted(event, d) {
                d3.select(this).raise();
            }

            function dragged(event, d) {
                d.x = event.x;
                d.y = event.y;
                d3.select(this).attr('transform', `translate(${d.x},${d.y})`);
                link.attr('d', linkPath);
            }

            function dragended(event, d) {
                // Position stays where dropped
            }

            // Search functionality
            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (!query) {
                    node.classed('dimmed', false);
                    link.classed('dimmed', false);
                    return;
                }

                const matchingNodes = new Set();
                nodes.forEach(n => {
                    if (n.name.toLowerCase().includes(query)) {
                        matchingNodes.add(n.id);
                    }
                });

                node.classed('dimmed', n => !matchingNodes.has(n.id));
                link.classed('dimmed', l => {
                    const srcId = typeof l.source === 'object' ? l.source.id : l.source;
                    const tgtId = typeof l.target === 'object' ? l.target.id : l.target;
                    return !matchingNodes.has(srcId) && !matchingNodes.has(tgtId);
                });
            });

            // Calculate bounding box and center view
            const allX = nodes.map(n => n.x);
            const allY = nodes.map(n => n.y);
            const minX = Math.min(...allX);
            const maxX = Math.max(...allX) + nodeWidth;
            const minY = Math.min(...allY);
            const maxY = Math.max(...allY) + nodeHeight;

            const graphWidth = maxX - minX;
            const graphHeight = maxY - minY;
            const centerX = minX + graphWidth / 2;
            const centerY = minY + graphHeight / 2;

            // Auto-fit the graph in view
            const scale = Math.min(
                (width - 100) / graphWidth,
                (height - 100) / graphHeight,
                1.2
            );
            const translateX = width / 2 - centerX * scale;
            const translateY = height / 2 - centerY * scale;

            svg.call(zoom.transform, d3.zoomIdentity.translate(translateX, translateY).scale(scale));

            // Center on a specific node if provided
            if (data.centerNode) {
                const centerNode = nodes.find(n =>
                    n.id === data.centerNode || n.name === data.centerNode
                );
                if (centerNode) {
                    setTimeout(() => {
                        showDetails(centerNode);
                    }, 500);
                }
            }
        }

        function showDetails(node) {
            const panel = document.getElementById('details-panel');
            const content = document.getElementById('details-content');

            const typeColors = {
                model: '#6c63ff',
                source: '#00c9a7',
                seed: '#ffc75f',
                snapshot: '#ff6b6b'
            };

            let columnsHtml = '';
            if (node.columns && Object.keys(node.columns).length > 0) {
                columnsHtml = `
                    <div class="detail-section">
                        <h3>Columns (${Object.keys(node.columns).length})</h3>
                        <div class="columns-list">
                            ${Object.values(node.columns).map(col => `
                                <div class="column-item">
                                    <div class="column-header">
                                        <span class="column-name">${col.name}</span>
                                        ${col.data_type ? `<span class="column-type">${col.data_type}</span>` : ''}
                                    </div>
                                    ${col.description ? `<div class="column-desc">${col.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            let tagsHtml = '';
            if (node.tags && node.tags.length > 0) {
                tagsHtml = `
                    <div class="detail-section">
                        <h3>Tags</h3>
                        <div class="tags-list">
                            ${node.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            let sqlHtml = '';
            if (node.raw_sql) {
                sqlHtml = `
                    <div class="detail-section">
                        <h3>SQL</h3>
                        <pre class="sql-preview">${escapeHtml(node.raw_sql)}</pre>
                    </div>
                `;
            }

            content.innerHTML = `
                <h2>${node.name}</h2>
                <span class="resource-type" style="background: ${typeColors[node.resource_type] || '#888'}">
                    ${node.resource_type}
                </span>

                ${node.description ? `
                    <div class="detail-section">
                        <h3>Description</h3>
                        <p>${node.description}</p>
                    </div>
                ` : ''}

                <div class="detail-section">
                    <h3>Location</h3>
                    <p>
                        <span class="value">${node.database || 'N/A'}</span>.<span class="value">${node.schema || 'N/A'}</span>
                    </p>
                </div>

                ${node.materialized ? `
                    <div class="detail-section">
                        <h3>Materialization</h3>
                        <p><span class="value">${node.materialized}</span></p>
                    </div>
                ` : ''}

                ${node.file_path ? `
                    <div class="detail-section">
                        <h3>File Path</h3>
                        <p><span class="value">${node.file_path}</span></p>
                    </div>
                ` : ''}

                ${tagsHtml}
                ${columnsHtml}
                ${sqlHtml}
            `;

            panel.classList.add('visible');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close details panel
        document.getElementById('close-details').addEventListener('click', () => {
            document.getElementById('details-panel').classList.remove('visible');
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            // Could reinitialize the graph here if needed
        });
    </script>
</body>
</html>
